name: Build and Release

on:
    push:
        tags:
            - 'v*' # å½“æŽ¨é€ v å¼€å¤´çš„ tag æ—¶è§¦å‘ï¼Œå¦‚ v1.4.0

jobs:
    build-and-release:
        runs-on: ubuntu-latest

        permissions:
            contents: write # éœ€è¦å†™å…¥æƒé™æ¥åˆ›å»º release

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # èŽ·å–å®Œæ•´åŽ†å²ï¼Œç”¨äºŽç”Ÿæˆæ›´æ–°æ—¥å¿—

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '22'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Build Chrome extension
              run: npm run zip

            - name: Build Firefox extension
              run: npm run zip:firefox

            - name: Get version from tag
              id: get_version
              run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

            - name: Generate release notes
              id: release_notes
              run: |
                  # èŽ·å–ä¸Šä¸€ä¸ª tag
                  PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

                  if [ -z "$PREV_TAG" ]; then
                    # å¦‚æžœæ²¡æœ‰ä¸Šä¸€ä¸ª tagï¼ŒèŽ·å–æ‰€æœ‰æäº¤
                    COMMITS=$(git log --pretty=format:"- %s" --no-merges)
                  else
                    # èŽ·å–ä¸¤ä¸ª tag ä¹‹é—´çš„æäº¤
                    COMMITS=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s" --no-merges)
                  fi

                  # å°†å¤šè¡Œå†…å®¹å†™å…¥æ–‡ä»¶
                  echo "## ðŸŽ‰ ç‰ˆæœ¬ ${{ steps.get_version.outputs.VERSION }} æ›´æ–°å†…å®¹" > release_notes.md
                  echo "" >> release_notes.md
                  echo "### ðŸ“ æ›´æ–°æ—¥å¿—" >> release_notes.md
                  echo "" >> release_notes.md
                  echo "$COMMITS" >> release_notes.md
                  echo "" >> release_notes.md
                  echo "---" >> release_notes.md
                  echo "" >> release_notes.md
                  echo "### ðŸ“¦ å®‰è£…è¯´æ˜Ž" >> release_notes.md
                  echo "" >> release_notes.md
                  echo "**Chrome æµè§ˆå™¨ï¼š**" >> release_notes.md
                  echo "1. ä¸‹è½½ \`bili-filter-${{ steps.get_version.outputs.VERSION }}-chrome.zip\`" >> release_notes.md
                  echo "2. æ‰“å¼€ \`chrome://extensions/\`" >> release_notes.md
                  echo "3. å¼€å¯ã€Œå¼€å‘è€…æ¨¡å¼ã€" >> release_notes.md
                  echo "4. è§£åŽ‹ zip æ–‡ä»¶ï¼Œå°†æ–‡ä»¶å¤¹æ‹–å…¥æµè§ˆå™¨" >> release_notes.md
                  echo "" >> release_notes.md
                  echo "**Firefox æµè§ˆå™¨ï¼š**" >> release_notes.md
                  echo "1. ä¸‹è½½ \`bili-filter-${{ steps.get_version.outputs.VERSION }}-firefox.zip\`" >> release_notes.md
                  echo "2. æ‰“å¼€ \`about:debugging#/runtime/this-firefox\`" >> release_notes.md
                  echo "3. ç‚¹å‡»ã€Œä¸´æ—¶è½½å…¥é™„åŠ ç»„ä»¶ã€" >> release_notes.md
                  echo "4. é€‰æ‹©è§£åŽ‹åŽçš„ zip æ–‡ä»¶" >> release_notes.md
                  echo "" >> release_notes.md
                  echo "**Edge æµè§ˆå™¨ï¼š**" >> release_notes.md
                  echo "1. ä¸‹è½½ \`bili-filter-${{ steps.get_version.outputs.VERSION }}-chrome.zip\`ï¼ˆEdge å…¼å®¹ Chrome æ‰©å±•ï¼‰" >> release_notes.md
                  echo "2. æ‰“å¼€ \`edge://extensions/\`" >> release_notes.md
                  echo "3. å¼€å¯ã€Œå¼€å‘äººå‘˜æ¨¡å¼ã€" >> release_notes.md
                  echo "4. è§£åŽ‹ zip æ–‡ä»¶ï¼Œå°†æ–‡ä»¶å¤¹æ‹–å…¥æµè§ˆå™¨" >> release_notes.md

            - name: Create Release
              uses: softprops/action-gh-release@v2
              with:
                  name: 'V${{ steps.get_version.outputs.VERSION }}'
                  body_path: release_notes.md
                  draft: false
                  prerelease: false
                  files: |
                      .output/bili-filter-${{ steps.get_version.outputs.VERSION }}-chrome.zip
                      .output/bili-filter-${{ steps.get_version.outputs.VERSION }}-firefox.zip
                      .output/bili-filter-${{ steps.get_version.outputs.VERSION }}-sources.zip
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
