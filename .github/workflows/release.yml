name: Build and Release

on:
    push:
        tags:
            - 'v*' # ÂΩìÊé®ÈÄÅ v ÂºÄÂ§¥ÁöÑ tag Êó∂Ëß¶ÂèëÔºåÂ¶Ç v1.4.0
    workflow_dispatch:

jobs:
    build-and-release:
        runs-on: ubuntu-latest

        permissions:
            contents: write # ÈúÄË¶ÅÂÜôÂÖ•ÊùÉÈôêÊù•ÂàõÂª∫ release

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Ëé∑ÂèñÂÆåÊï¥ÂéÜÂè≤ÔºåÁî®‰∫éÁîüÊàêÊõ¥Êñ∞Êó•Âøó

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '22'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Build Chrome extension
              run: npm run zip

            - name: Build Firefox extension
              run: npm run zip:firefox

            - name: Get version from tag
              id: get_version
              run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

            - name: Generate release notes
              id: release_notes
              run: |
                  # Ëé∑Âèñ‰∏ä‰∏Ä‰∏™ tag
                  PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

                  if [ -z "$PREV_TAG" ]; then
                    # Â¶ÇÊûúÊ≤°Êúâ‰∏ä‰∏Ä‰∏™ tagÔºåËé∑ÂèñÊâÄÊúâÊèê‰∫§
                    COMMITS=$(git log --pretty=format:"- %s" --no-merges)
                  else
                    # Ëé∑Âèñ‰∏§‰∏™ tag ‰πãÈó¥ÁöÑÊèê‰∫§
                    COMMITS=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s" --no-merges)
                  fi

                  # Â∞ÜÂ§öË°åÂÜÖÂÆπÂÜôÂÖ•Êñá‰ª∂
                  echo "## üéâ ÁâàÊú¨ ${{ steps.get_version.outputs.VERSION }} Êõ¥Êñ∞ÂÜÖÂÆπ" > release_notes.md
                  echo "" >> release_notes.md
                  echo "### üìù Êõ¥Êñ∞Êó•Âøó" >> release_notes.md
                  echo "" >> release_notes.md
                  echo "$COMMITS" >> release_notes.md
                  echo "" >> release_notes.md
                  echo "---" >> release_notes.md
                  echo "" >> release_notes.md
                  echo "### üì¶ ÂÆâË£ÖËØ¥Êòé" >> release_notes.md
                  echo "" >> release_notes.md
                  echo "**Chrome ÊµèËßàÂô®Ôºö**" >> release_notes.md
                  echo "1. ‰∏ãËΩΩ \`bili-filter-${{ steps.get_version.outputs.VERSION }}-chrome.zip\`" >> release_notes.md
                  echo "2. ÊâìÂºÄ \`chrome://extensions/\`" >> release_notes.md
                  echo "3. ÂºÄÂêØ„ÄåÂºÄÂèëËÄÖÊ®°Âºè„Äç" >> release_notes.md
                  echo "4. Ëß£Âéã zip Êñá‰ª∂ÔºåÂ∞ÜÊñá‰ª∂Â§πÊãñÂÖ•ÊµèËßàÂô®" >> release_notes.md
                  echo "" >> release_notes.md
                  echo "**Firefox ÊµèËßàÂô®Ôºö**" >> release_notes.md
                  echo "1. ‰∏ãËΩΩ \`bili-filter-${{ steps.get_version.outputs.VERSION }}-firefox.zip\`" >> release_notes.md
                  echo "2. ÊâìÂºÄ \`about:debugging#/runtime/this-firefox\`" >> release_notes.md
                  echo "3. ÁÇπÂáª„Äå‰∏¥Êó∂ËΩΩÂÖ•ÈôÑÂä†ÁªÑ‰ª∂„Äç" >> release_notes.md
                  echo "4. ÈÄâÊã©Ëß£ÂéãÂêéÁöÑ zip Êñá‰ª∂" >> release_notes.md
                  echo "" >> release_notes.md
                  echo "**Edge ÊµèËßàÂô®Ôºö**" >> release_notes.md
                  echo "1. ‰∏ãËΩΩ \`bili-filter-${{ steps.get_version.outputs.VERSION }}-chrome.zip\`ÔºàEdge ÂÖºÂÆπ Chrome Êâ©Â±ïÔºâ" >> release_notes.md
                  echo "2. ÊâìÂºÄ \`edge://extensions/\`" >> release_notes.md
                  echo "3. ÂºÄÂêØ„ÄåÂºÄÂèë‰∫∫ÂëòÊ®°Âºè„Äç" >> release_notes.md
                  echo "4. Ëß£Âéã zip Êñá‰ª∂ÔºåÂ∞ÜÊñá‰ª∂Â§πÊãñÂÖ•ÊµèËßàÂô®" >> release_notes.md

            - name: Create Release
              uses: softprops/action-gh-release@v2
              with:
                  name: 'V${{ steps.get_version.outputs.VERSION }}'
                  body_path: release_notes.md
                  draft: false
                  prerelease: false
                  files: |
                      .output/bili-filter-${{ steps.get_version.outputs.VERSION }}-chrome.zip
                      .output/bili-filter-${{ steps.get_version.outputs.VERSION }}-firefox.zip
                      .output/bili-filter-${{ steps.get_version.outputs.VERSION }}-sources.zip
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            # ====================================
            # Ëá™Âä®ÂèëÂ∏ÉÂà∞Êâ©Â±ïÂïÜÂ∫ó
            # ====================================
            - name: Submit to Edge Add-ons
              run: |
                  npx wxt submit \
                    --edge-zip .output/bili-filter-${{ steps.get_version.outputs.VERSION }}-chrome.zip
              env:
                  EDGE_CLIENT_ID: ${{ secrets.EDGE_CLIENT_ID }}
                  EDGE_API_KEY: ${{ secrets.EDGE_API_KEY }}
                  EDGE_PRODUCT_ID: ${{ secrets.EDGE_PRODUCT_ID }}
